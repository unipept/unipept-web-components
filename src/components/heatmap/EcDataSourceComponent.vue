<template>
    <div>
        <v-select :items="ecNameSpaces" v-model="selectedNameSpace" label="Namespace"></v-select>
        <v-data-table v-model="selectedItems" :headers="headers" :items="items" select-all item-key="code" v-bind:pagination.sync="pagination" :loading="loading">
            <template v-slot:items="props">
                <tr :active="props.selected" @click="props.selected = !props.selected">
                    <td>
                        <v-checkbox :input-value="props.selected" primary hide-details></v-checkbox>
                    </td>
                    <td>{{ props.item.name }}</td>
                    <td>{{ props.item.code }}</td>
                    <td class="text-xs-right">{{ props.item.popularity }}</td>
                </tr>
            </template>
        </v-data-table>
    </div>
</template>

<script lang="ts">
import Vue from "vue";
import Component, { mixins } from "vue-class-component";
import { Prop, Watch } from "vue-property-decorator";
import EcDataSource from "../../logic/data-source/EcDataSource";
import { EcNameSpace, convertEcNumberToEcNameSpace, convertStringToEcNameSpace } from "../../logic/functional-annotations/EcNameSpace";
import EcNumber from "../../logic/functional-annotations/EcNumber";
import DataSourceMixin from "./DataSourceMixin.vue";

    @Component
export default class EcDataSourceComponent extends mixins(DataSourceMixin) {
    // TODO This component should be merged with the GoDataSourceComponent to reduce code duplication

        private ecNameSpaces: string[] = ["all"].concat(Object.values(EcNameSpace)).map(el => this.capitalize(el));
        private selectedNameSpace: string = this.ecNameSpaces[0];

        private items: EcNumber[] = [];
        private selectedItems: Element[] = [];

        private loading: boolean = true;

        private headers = [
            {
                text: "Name",
                align: "left",
                value: "name"
            },
            {
                text: "Code",
                align: "left",
                value: "code"
            },
            {
                text: "# peptides",
                align: "left",
                value: "popularity"
            }
        ];

        private pagination = { "sortBy": "popularity", "descending": true, "rowsPerPage": 5 }

        mounted() {
            this.onSelectedNameSpaceChanged();
        }

        @Watch("selectedNameSpace")
        async onSelectedNameSpaceChanged() {
            this.loading = true;
            // Reset lists without changing the list-object reference.
            this.items.length = 0;
            this.selectedItems.length = 0;

            let result: EcNumber[] = await (this.dataSource as EcDataSource).getTopItems(30, convertStringToEcNameSpace(this.selectedNameSpace));
            this.items.push(...result);
            this.loading = false;
        }

        @Watch("selectedItems", { deep: true })
        async onSelectedItemsChanged() {
            this.$emit("selected-items", this.selectedItems);
        }
}
</script>

<style scoped>
</style>